
# Topic Mapping Interface - API doc

The Topic Mapping Interface script and stylesheet bundles are located in [`app/dist`](../app/dist).

The stylesheet contains the styles of all page modules as well as default styles for the page overall.
Check [this section](#styles) for more details.

The script sets up `tMap`, the top level library object for interacting with the Topic Map interface and its modules.

- [Page Layout Management](#page-manager)
- [Data Management](#data-manager)
- [State Management](#state-manager)
- [Visualisation Modules](#visualisation-modules)
    - [Bubble Topic Map](#bubble-topic-map)
    - [Wordcloud](#worcloud)
    - [Trend Chart](#trend-chart)
    - [Bar Chart](#bar-chart)
    - [Line Chart](#line-chart)


## Page Manager

The page manager sets a grid on the HTML page that will automatically position and size containers for the modules.

It is instantiated as follow:
```javascript
let PM = tMap.PageManager(container, layout, controls, header, footer, minWidth, minHeight);
```
- `container` is a string selector for the DOM element that will contain all modules, e.g. `'div#app'`. It defaults to `'body'`.
- `layout` is a string specifying the desired page layout. It defaults to `'A'` (one panel taking the whole space).
- `controls` is a string specifying the desired page controls and there position. It defaults to `''` (no controls).
- `header` and `footer` are the string selectors for the DOM element acting as page header and footer. Their height will be deducted when computing the page size. They both default to `''` (no element).
- `minWidth` and `minHeight` are integers used to set the page minimum size. They both default to `600`. 

For more detail about the layout and controls parameters, check [this page](./PageLayouts.md).

The Page Manager instance created, `PM`, is an object listing the selectors and sizes of each panels generated. For example, if you choose to generate layout with 3 panels and 2 controls, `PM` will contain 5 attributes: `panel1`, `panel2`, `panel3`, `control1`, and `control2`. Each of these attributes will have 3 attributes of their own: `c` the string selector for the container created, `w` the width available for it, and `h` the height.
```javascript
PM.panel1.c // --> the selector for panel1 container, typically 'div#panel1'
PM.panel1.w // --> the width available for panel1, e.g. 500
PM.panel1.h // --> the height available for panel1, e.g. 300
```

### Page Responsivity

The Page Manager instance also has a `watch` function available:
```javascript
PM.watch({
    panel: module
})
```

This provides a map between the panels' names and the interface modules. During window resizing, Page Manager will recompute the panels' sizes and automatically updates the modules.


## Data Manager

The data manager facilitates the loading and interaction with the data files generated by the Topic Mapping Pipeline.

It is instantiated as follow:
```javascript
let DM = tMap.DataManager();
```

You can then access the data management features from `DM`.

- [Processing Data](#processing-data)
- [Map features](#map-features)
- [Document List features](#document-list-features)
- [Distribution features](#distribution-features)
- [Trend features](#trend-features)
- [Search features](#search-features)

### Processing Data

#### `DataManager.loadDataFromUrls(urls)`

Loads data from the urls provided. The urls must be given in a object:
```javascript
DM.loadDataFromUrls({name1: url1, name2: url2});
``` 
Returns a promise object with a list of the loaded data as parameter, e.g.:
```javascript
[{name:name1,data:data1},{name:name2,data:data2}]
``` 

JSON and CSV files will be automatically parsed. Other formats will simply be read as a regular string.

#### `DataManager.processData(dataArray)`

Gets a setof data in the format `[{name,data}]` (i.e. generated by `.loadDataFromUrls`) and attaches the data to the data manager. For example:
```javascript
DM.processData([{name:name1,data:data1},{name:name2,data:data2}]);
``` 
Will be attached to `DM` like so:
```javascript
DM.data.name1 // -> data1
DM.data.name2 // -> data2
```

#### `DataManager.loadAndProcessDataFromUrls(urls)`

Combines `.loadDataFromUrls` and `.processData` together. Takes a set of urls as input, attaches the data to the data manager instance, and returns a promise object (with no parameters):
```javascript
DM.loadAndProcessDataFromUrls({name1: url1, name2: url2}).then(()=>{
    console.log(DM.data.name1); // -> data1
    console.log(DM.data.name2); // -> data2
});
```

#### Important Notes

While any url and data name can be passed to `.loadAndProcessDataFromUrls`, other features of the data manager expect specific names and data structures:
- `mainMap` (and `subMaps`): the main map (and set of sub maps) JSON file(s) generated by the Topic Mapping Pipeline's mapping modules;
- `mainModel` (and `subModel`): the main model (and sub model) JSON file(s) generated by the Topic Mapping Pipeline's export model module;
- `distribution`: any distribution JSON file generated by the Topic Mapping Pipeline's topic distribution module (only one non-date `distribution` is supported);
- `trend`: a date distribution JSON file generated by the Topic Mapping Pipeline's topic distribution module;
- `labelsIndex`: the labels index JSON file generated by the Topic Mapping Pipeline's label indexing module.

These features provide shortcut to accessing and processing the data files to fit with the page's modules.

### Map features

These features let you access and interact with the data from `mainMap` and `subMaps`.

#### `DataManager.setSubMap(topicId)`

Given a the id of a topic from the main map, gets the sub map data attached to it and saves it to the `subMap` data attribute of the manager (for later access). Will throw and error if `subMaps` was not loaded or if no sub map can be found with this main topic id.
```javascript
DM.setSubMap('2');
console.log(DM.data.subMap); // -> sub map data assigned to main topic with id '2'
```

#### `DataManager.getSubMap([topicId])`

Same as `.setSubMap` but also returns the sub map data. `topicId` is optional here. If unspecified, the function will return the sub map data previously saved. If no sub map was previously set and no topic id is provided, the function will throw an error. The function can also throw errors from `.setSubMap` by proxy.
```javascript
let map = DM.getSubMap('2');
console.log(map); // -> sub map data assigned to main topic with id '2'

DM.setSubMap('5');
let map = DM.getSubMap();
console.log(map); // -> sub map data assigned to main topic with id '5'
```

#### `DataManager.getTopicMainMap(topicId)`

Returns the data (labels, position, etc.) for the topic with id `topicId` from the main map. Will throw an error if `mainMap` was not loaded or if no topic can be found with the specified id.
```javascript
let t = DM.getTopicMainMap('3');
console.log(t); // -> topic data for topic with id '3' in main map
```

#### `DataManager.getTopicSubMap(topicId)`

Returns the data (labels, position, etc.) for the topic with id `topicId` from the sub map previously saved with `setSubMap`. Will throw an error if no sub map was previously set or if no topic can be found with the specified id.
```javascript
let t = DM.getTopicSubMap('1');
console.log(t); // -> topic data for topic with id '1' in sub map
```

### Document List features

These features let you access and interact with the document lists inside the `mainModel` and `subModel`.

#### `DataManager.setTableRowsMainTopic(topicId)`

Given a topic id from the main model, will set the data attribute `tableRows` to the topic's top documents. If no topic is found `tableRows` is set to an empty list. If `mainModel` was not loaded, the function will throw an error.
```javascript
DM.setTableRowsMainTopic('4');
console.log(DM.data.tableRows); // -> the list of top documents for topic '4' in the main model
``` 

#### `DataManager.setTableRowsSubTopic(topicId)`

Same as above but with topics from the sub model.
```javascript
DM.setTableRowsSubTopic('6');
console.log(DM.data.tableRows); // -> the list of top documents for topic '6' in the sub model
``` 

#### `DataManager.getTableRows([number [, filter]])`

Returns the list of documents saved in `tableRows` with the methods above. `number` is optional and lets you crop the list to the top x document entries, its default value is `10`. `filter` is optional too and lets you provide a function to filter the documents (before croping the list), its default value is `()=>true` (no filter). The function will throw an error if `tableRows` has not been set.
```javascript
DM.setTableRowsMainTopic('4');
let d = DM.getTableRows(30, d=>d.published);
console.log(d); // -> list of the top 30 documents, that were "published", from topic '4' in the main model 
```

#### `DataManager.getDocument(docId)`

Given a document id, returns the associated document data saved in `tableRows`. The function will throw an error if `tableRows` has not been set or is empty, or if no document with such id can be found. 
```javascript
DM.setTableRowsMainTopic('4');
let d = DM.getDocument('43');
console.log(d); // -> data for the document '43', which is in the top documents for topic '4' in the main model.
```

### Distribution features

These features let you access and interact with the `distribution` data. This type of data is generated by the Topic Mapping Pipeline's topic distribution module. Note that date distributions have [separate features](#trend-features).

#### `DataManager.getDistributionLabels([textTransform])`

Returns the list of the distribution's fields labels. `textTransform` is an optional function that lets you transform the labels' text for display, it defaults to `d=>d` (identity function). The returned list will be in the format: `[{value, text}, ...]` where `value` is the original label value and `text` is the transformed value. This function will throw an error if `distribution` has not been set.
```javascript
let l = DM.getDistributionLabels(t=>`Category ${t}`);
console.log(l); // -> list of fields, e.g. [{value:'A', text:'Category A'},{value:'B', text:'Category B'},{value:'C', text:'Category C'}]
```

#### `DataManager.getMainTopicsDistrib(fieldName)`

Returns the topic distribution of main topics, given a field name. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the field name provided is not part of the distribution.
```javascript
let d = DM.getMainTopicsDistrib('A');
console.log(d); // -> main topic distribution for field A, e.g. [{topicId: '0', value: 32.0}, {topicId: '1', value: 10.0}, ...]
```

#### `DataManager.getSubTopicsDistrib(fieldName)`

Same as above for sub topics.

#### `DataManager.getMainTopicsDistribNormPerTopic(fieldName)`

Returns the topic distribution of main topics, given a field name. The values returned are normalised using the total distribution value for each topic: `v_final = v_topic_field / total_topic`. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the field name provided is not part of the distribution.
```javascript
let d = DM.getMainTopicsDistribNormPerTopic('A');
console.log(d); // -> main topic distribution for field A normalised per topic (across the other fields), e.g. [{topicId: '0', value: 0.3}, {topicId: '1', value: 0.6}, ...]
```

#### `DataManager.getSubTopicsDistribNormPerTopic(fieldName)`

Same as above for sub topics.

#### `DataManager.getMainTopicsDistribNormPerField(fieldName)`

Returns the topic distribution of main topics, given a field name. The values returned are normalised using the total distribution value for each field: `v_final = v_topic_field / total_field`. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the field name provided is not part of the distribution.
```javascript
let d = DM.getMainTopicsDistribNormPerField('A');
console.log(d); // -> main topic distribution for field A normalised across the topics, e.g. [{topicId: '0', value: 0.063}, {topicId: '1', value: 0.13}, ...]
```

#### `DataManager.getSubTopicsDistribNormPerField(fieldName)`

Same as above for sub topics.

#### `DataManager.getMainTopicDistribEntry(topicId)`

Returns the distribution entry for the topic with the specified id. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the topic id provided is not found.
```javascript
let d = DM.getMainTopicDistribEntry('1');
console.log(d); // -> distribution entry for main topic '1', e.g. [{key: 'A', value: 10.0}, {key: 'B', value: 5.0}, ...]
```

#### `DataManager.getSubTopicDistribEntry(topicId)`

Same as above for sub topics.
  
#### `DataManager.getMainTopicDistribEntryNorm(topicId)`

Returns the distribution entry for the topic with the specified id. Each value returned will be normalised by the total weight for this topic. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the topic id provided is not found.
```javascript
let d = DM.getMainTopicDistribEntryNorm('1');
console.log(d); // -> distribution entry for main topic '1' normalised, e.g. [{key: 'A', value: 0.6}, {key: 'B', value: 0.3}, ...]
```

#### `DataManager.getSubTopicDistribEntry(topicId)`

Same as above for sub topics.

### Trend features

These features let you access and interact with the `trend` data. This type of data is generated by the Topic Mapping Pipeline's topic distribution module, when applied on date fields.

#### `DataManager.timeFormatConverter(inParse, outFormat)`

Returns a function that converts date formats.
```javascript
let convert = DM.timeFormatConverter('%d/%m/%y', '%Y-%m');
console.log(convert('04/05/12')) // -> '2012-05'
```
Refer to [D3's documentation](https://github.com/d3/d3-time-format#locale_format) for more details about the format specification.

This function is particularly useful when trying to aggregate values by months or years. As such, it also has a duplicate name: `DataManager.getTrendSumByFunction(inParse, outFormat)`.

#### `DataManager.getMainTopicTrend(topicId [,sumBy [,timeRange]])`

Given the id of a main topic, returns the trend for this topic, in the format: `[{date, value}]`. `sumBy` is a optional function that lets you aggregate the distribution value by date, e.g. by month or by year, this function is essentially a date converter that `.timeFormatConverter` or `.getTrendSumByFunction` produce. `timeRange` is a optional range that lets you filter the distribution dates, this range is defined as a list of three strings: `[format, minDate, maxDate]`, `minDate` will be included and `maxDate` excluded.

This function will throw errors if: the trend data was not loaded; the trend data does not have main topics; the topic was not found; or the timeRange, if given, was not correct.

```javascript
let convert = DM.timeFormatConverter('%d/%m/%y', '%Y-%m');
let range = ['%d/%m/%y', '01/01/2012', '01/07/2012'];
let d = DM.getMainTopicTrend('1', convert, range);
console.log(d); // -> trend for the main topic '1', grouped by month, between January and June (both included)
```

#### `DataManager.getMainTopicTrend(topicId [,sumBy [,timeRange]])`

Same as above for sub topics.

#### `DataManager.getMaxTrend([sumBy])`

Returns the maximum value in the `trend` data, across all topics. The optional `sumBy` function lets you aggregate the maximum value by a specific time period (year, month, etc.).
```javascript
let convert = DM.timeFormatConverter('%d/%m/%y', '%Y-%m');
let maxValue = DM.getMaxTrend(convert);
console.log(maxValue); // -> maximum value of the trend, across all topics, by month
```

### Search features

These features let you access and interact with the `labelsIndex` data, enabling search functionalities.

#### `DataManager.setSearchTerm(string)`

Saves a string as the search term for later functions.
```javascript
DM.setSearchTerm('label1 label2; label3');
console.log(DM.data.searchTerm); // -> 'label1 label2; label3'
```

The search term can be composed of multiple labels, organised with logic operators:
- `and`, `+`, ` ` (space): connect labels with an `AND`;
- `or`, `*`, `;`: connect labels (or multiple labels connected by `AND`) with an `OR`;

If the search term comprises only one word, with space at the end of it, the future search functions will consider every labels containting this word as substring.

#### `DataManager.processWordInSearch(word [,searchValue [,append]])`

Allows you to safely process a word in a search string. If the word is not in the search, the function will append it to the end of the search string (with the `append` character which defaults to `;`). If the word is already in the search, the function will remove it. `searchValue` is optional (defaults to `null`), if not specified or set to `null`, the function will use the search term set by `.setSearchTerm` and update it. The function returns the new search string.
```javascript
let s = DM.processWordInSearch('word', 'search string', '-');
console.log(s); // -> 'search string- word'

let s = DM.processWordInSearch('search', 'search string');
console.log(s); // -> 'string'

DM.setSearchTerm('label1 label2; label3');
DM.processWordInSearch('label4');
console.log(DM.data.searchTerm); // -> 'label1 label2; label3; label4'
```

#### `DataManager.getDocIdsFromSearch()`

Returns the ids of documents matching the search term set with `.setSearchTerm` in the `labelsIndex` data. The function will throw an error if `labelsIndex` has not been set.
```javascript
DM.setSearchTerm('label1 label2; label3');
let docIds = DM.getDocIdsFromSearch();
console.log(docIds); // -> the list of document ids containing 'label1' and 'label2', or 'label3'

DM.setSearchTerm('lab');
let docIds = DM.getDocIdsFromSearch();
console.log(docIds); // -> the list of document ids containing 'label1', 'label2', 'label3', or 'laboratory' ...
```

#### `DataManager.getTopicIdsFromSearch()`

Returns two sets of ids for the main and sub topics matching the search term set with `.setSearchTerm` in the `labelsIndex` data. The function will throw an error if `labelsIndex` has not been set.
```javascript
DM.setSearchTerm('label1 label2; label3');
let {mainTopicIds, subTopicIds} = DM.getTopicIdsFromSearch();
console.log(mainTopicIds); // -> the list of main topic ids containing 'label1' and 'label2', or 'label3'
console.log(subTopicIds); // -> the list of sub topic ids containing 'label1' and 'label2', or 'label3'

DM.setSearchTerm('lab');
let {mainTopicIds, subTopicIds} = DM.getTopicIdsFromSearch();
console.log(mainTopicIds); // -> the list of main topic ids containing 'label1', 'label2', 'label3', or 'laboratory' ...
console.log(subTopicIds); // -> the list of sub topic ids containing 'label1', 'label2', 'label3', or 'laboratory' ...
```

#### `DataManager.getLabelsFromSearch()`

Returns the exact set of labels matching the search term set with `.setSearchTerm` in the `labelsIndex` data. The function will throw an error if `labelsIndex` has not been set.
```javascript
DM.setSearchTerm('label1 label2; label3');
let labels = DM.getLabelsFromSearch();
console.log(labels); // -> [label1, label2, label3]

DM.setSearchTerm('lab');
let labels = DM.getLabelsFromSearch();
console.log(labels); // -> ['label1', 'label2', 'label3', 'laboratory', ...]
```

#### `DataManager.getFromSearch()`

A wrapper function for `.getLabelsFromSearch`, `.getTopicIdsFromSearch`, and `.getDocIdsFromSearch`, returning a object comprising the results of these other function. The function will throw an error if `labelsIndex` has not been set.

```javascript
DM.setSearchTerm('label1 label2; label3');
let {labels, docs, topics} = DM.getFromSearch();
console.log(topics.mainTopicIds); // -> the list of main topic ids containing 'label1' and 'label2', or 'label3'
console.log(topics.subTopicIds); // -> the list of sub topic ids containing 'label1' and 'label2', or 'label3'
console.log(docIds); // -> the list of document ids containing 'label1' and 'label2', or 'label3'
console.log(labels); // -> [label1, label2, label3]
```


## State Manager

The state manager offers a centralised system to set and access the various state of the application, e.g. selected main topic, current search value, or selected distribution.

It is instantiated as follow:
```javascript
let SM = tMap.StateManager();
```

You can then access the state management methods from `SM`.

- [Setting/Accessing States](#states)
- [URL features](#url-features)

### States

There are currently six states controlled by the State Manager:
- `mainTopic`: the topic selected on a main map;
- `subTopic`: the topic selected on a sub map;
- `doc`: the document selected in a document table;
- `distrib`: the distribution field selected to set the maps' opacity;
- `date`: the date selected on a trend chart to filter documents; and
- `search`: the search string entered in the search box.

#### `StateManager.state(name [, value])`

If `value` is specified, lets you set it as the value for the state associated with `name`. If no `value` is given, returns the current value of the state associated with `name`. If no state can be found with `name`, the function will throw an error.
```javascript
SM.state('mainTopic', '20'); // -> set the currently selected topic on the main map to the topic with id '20'
SM.state('search', 'label1 label2'); // -> set the current search string to 'label1 label2'
SM.state('mainTopic'); // -> returns '20'
```

#### `StateManager.reset()`

Resets the state values to their default: `null`.
```javascript
SM.reset();
SM.state('mainTopic'); // -> returns null
```

### URL features

The State Managers includes features allowing you to build and parse URLs with the states' values embedded in them.

#### `StateManager.buildURL([customBase])`

Returns a URL string with the states' values embedded. `customBase` is an optional string letting you define your own domain and path.
```javascript
// page is at domain.com/page.html
SM.state('mainTopic', '20');
SM.state('search', 'label1 label2');
SM.state('doc', '34');
let url = SM.buildURL();
console.log(url); // -> https://domain.com/page.html?t=20&d=34&s=label1%20label2 

let url = SM.buildURL('domain.com/otherPage.html');
console.log(url); // -> https://domain.com/otherPage.html?t=20&d=34&s=label1%20label2 
```

#### `StateManager.parseURL()`

Parses the HTML document's URL and sets the states accordingly.
```javascript
// document URL : https://domain.com/page.html?t=20&d=34&s=label1%20label2
SM.parseURL();
console.log(SM.state('mainTopic')); // -> '20'
console.log(SM.state('search')); // -> 'label1 label2'
``` 


## Visualisation Modules

The visualisation modules all share [the same base API](#visualisation-api). At this stage, the Topic Mapping Interface comprises the following visualisation modules:
- [Bubble Topic Map](#bubble-topic-map)
- [Wordcloud](#worcloud)
- [Trend Chart](#trend-chart)
- [Bar Chart](#bar-chart)
- [Line Chart](#line-chart)

### Visualisation API

The visualisation modules are all built from the same base module, meaning that they share a common base API.

> Note that all of the functions below return the visualisation module itself, unless specified otherwise.
> This allows you to chain this functions.

#### `Visualisation.setWidth(value)`

Sets the width of the visualisation, and automatically adjust its internal elements.
```javascript
let v = tMap.someVisualisation();
v.setWidth(600); // -> the visualisation width to 600 px
```

#### `Visualisation.setHeight(value)`

Sets the height of the visualisation, and automatically adjust its internal elements.
```javascript
let v = tMap.someVisualisation();
v.setHeight(300); // -> the visualisation height to 300 px
```

#### `Visualisation.setSize(width, height)`

Sets the width and height of the visualisation, and automatically adjust its internal elements.
```javascript
let v = tMap.someVisualisation();
v.setSize(600,300); // -> the visualisation width to 600 px and height to 300 px
```

#### `Visualisation.setMargin(values)`

Sets the margins of the visualisation, and automatically adjust its internal elements. The margins are given as a list: `[top, bottom, left, right]`.
```javascript
let v = tMap.someVisualisation();
v.setMargin([10,20,30,10]); // -> the visualisation margins to 10px top, 20px bottom, 30px left, and 10px right
```

#### `Visualisation.toggleBorder([boolean])`

Toggles a border around the visualisation module. The `boolean` parameter lets you specify which state you want: `true` = on, and `false` = off. It is optional will default to the opposite of the visualisation current state. Note that the visualisation border is on by default.
```javascript
let v = tMap.someVisualisation(); // -> the visualisation border is on
v.toggleBorder(true); // -> turns on the visualisation border (no effect)
v.toggleBorder(false); // -> removes the visualisation border
v.toggleBorder(); // -> turns on the visualisation border
v.toggleBorder(); // -> turns off the visualisation border
```

#### `Visualisation.toggleButton(position [,text, callback])`

Toggles a button on the visualisation. Each visualisation module can have four buttons, each identified by a `position`: `'TL'` for the top-left corner, `'TR'` for the top-right corner, `'BL'` for the bottom-left corner, and `'BR'` for the bottom-right corner. To toggle a button on, you must specify its `text` and `callback` function too. To turn it off, just specify the `position`.
```javascript
let v = tMap.someVisualisation();
v.toggleButton('BL', 'Action', ()=>{console.log('action BL')}); // adds a button to the bottom-left corner, with text 'Action', that prints 'action BL' to the console.
v.toggleButton('BL'); // removes the button at the bottom-left corner.
```

#### `Visualisation.toggleTitle([text, [position]])`

Toggles a title on the visualisation. If `text` is specified, toggles the title on with this text, otherwise toggles the title off. `position` lets you choose where you want the title, either at the top `'T'` (default) or bottom `'B'` of the visualisation.
```javascript
let v = tMap.someVisualisation();
v.toggleTitle('Visualisation'); // -> puts 'Visualisation' as the top of the visualisation
v.toggleTitle('Visualisation', 'B'); // -> moves 'Visualisation' as the bottom of the visualisation
v.toggleTitle(); // -> removes 'Visualisation' from the visualisation
```

#### `Visualisation.addDefaultText(string [,scale [,blinking]])

Puts a message, `string`, at the center of the visualisation. `scale` lets you specify the message size, defaults to 1. `blinking` lets you specify if you want the message to blink `true` or not `false` (default), for example when loading data.
```javascript
let v = tMap.someVisualisation();
v.addDefaultText('Loading data', 1.5, true); // -> large blinking text saying 'Loading data'
``` 
Note that any message printed this way will be automatically removed once the visualisation is rendered.


### Bubble Topic Map

The bubble map visualisation module renders data from `mainMap` and `subMaps` files, produced by the Topic Mapping Pipeline bubble map module.

A Bubble Map is instantiated using `tMap`'s `BubbleMap` function. Like most page modules, it takes three parameters: a DOM `container`, and initial `width` and `height`. These parameters are typically returned by the [Page Manager](#page-manager).
```javascript
let PM = tMap.PageManager(...);
let bubbleMap = tMap.BubbleMap(PM.panel1.c, PM.panel1.w, PM.panel1.h);
```

This module is built with [the visualisation API](#visualisation-api) and therefore has the same base methods.

> Note that all of the functions below return the visualisation module itself, unless specified otherwise.
> This allows you to chain this functions.

#### `BubbleMap.setBubbleClick(callback)`

Sets a callback for click events on the map's bubbles.
```javascript
bubbleMap.setBubbleClick((e,d)=>{console.log(d)}); // -> on bubble click print the bubble's datum
```

> Note that the callback has to follow D3 v6.0's callback signature:
> `callback(event, datum)`
> Check [D3 v6.0 migration guide](https://observablehq.com/@d3/d3v6-migration-guide#events) for more details

#### `BubbleMap.setTooltip(textFunction)`

Sets the function used to build the bubbles' tooltip text. If defined, this text function will be called with the bubble's datum as parameter. You can set this text function to `null` in order to disable the text tooltip.
```javascript
bubbleMap.setTooltip(d=>`Size: ${d.size}`); // bubbles' tooltip will print 'Size: 23.0' for example.
```

#### `BubbleMap.setTooltipChart(charFunction)`

Sets the function used to build the bubbles' tooltip chart. If defined, this chart function will be called with the tooltip's DOM container and the bubble's datum as parameter. You can set this chart function to `null` in order to disable the chart tooltip.
```javascript
let DM = tMap.DataManager();
bubbleMap.setTooltipChart((t,d)=>{
    tMap.HorizontalBarChart(t, 200, 100)
        .render(DM.getMainTopicDistribEntry(d.topicId));
}); // bubbles' tooltip include an horizontal bar chart showing the bubble's topic distribution.
```

#### `BubbleMap.setMinimumTextSize(size)`

Lets you set the minimum `size` the bubble's text can have. Note that the bubble will be scaled to fit inside the visualisation after being rendered, texts might appear larger/smaller than the value of `size`.
```javascript
bubbleMap.setMinimumTextSize(3); // bubbles' text can be no smaller than 3px (before map scaling).
```

#### `BubbleMap.render(dataset)`

Renders the bubble map using the provided `dataset`. This `dataset` can be accessed from the data manager, e.g. `DM.data.mainMap` or `DM.data.subMap`.
```javascript
bubbleMap.render(DM.data.mainMap); // renders the main topic map
bubbleMap.render(DM.getSubMap('2')); // renders the sub topic map for main topic '2'
```

#### `BubbleMap.selectBubble([topicId [,idAccessor]])`

If provided with topic id, will mark the associated bubble *selected* (using CSS class). All other bubbles are marked as not selected, i.e. only one bubble can be selected at a time. If `topicId` is not specified, or set to null, the function will unselect all bubbles. `idAccessor` lets you define how to access the topic id in the bubble map topic data, it defaults to `d=>d.topicId` which corresponds to how topic ids are stored in `mainMap` and `subMaps`.
```javascript
bubbleMap.selectBubble('2'); // bubble for topic '2' will be classed 'selected'
```

#### `BubbleMap.highlightBubbles([topicIds [,idAccessor]])`

Given a list of topic ids, will mark the associated bubbles as *highlighted* (using CSS class). Every other bubbles are marked as not highlighted. If `topicId` is not specified, or set to an empty list `[]`, the function will remove highlight for every bubbles. `idAccessor` lets you define how to access the topic id in the bubble map topic data, it defaults to `d=>d.topicId` which corresponds to how topic ids are stored in `mainMap` and `subMaps`.
```javascript
bubbleMap.selectBubble(['2','3','8','13']); // bubbles for topics '2','3','8', and '13' will be classed 'highlighted'
```

#### `BubbleMap.setBubblesOpacity(distributionData [,reset])

Given a distribution (list of topic ids/keys and weights/values), will adjust the opacity of bubbles to reflect the weights. `reset` is an optional parameter that lets you reset all the opacities to `1` (`true`), it defaults to `false`.
```javascript
bubbleMap.setBubblesOpacity(DM.getMainTopicsDistrib('A')); // sets the opacity of all bubbles using the distribution of field 'A'
```

#### `BubbleMap.setOpacityScale([minValue [, clampRatio [, scaleType]]])`

Lets you adjust the opacity scale used with `.setBubblesOpacity`. `minValue` is minimum opacity value of the scale's range, it defaults to `0.2`. The maximum range value is always `1`. `clampRatio` is a multiplier applied on the maximum value of scale's domain, allowing you to lower or increase the threshold for maximum opacity, it defaults to `1` (no changes). `scaleType` lets you choose what type of scale to use, either `linear` (default) or `log`.
```javascript
bubbleMap.setOpacityScale(0.3, 0.9, 'log'); // use a scale range of [0.3,1], a scale domain of [0, 90% of the distribution maximum value], and a logarithmic scale.
```


### Wordcloud

The wordcloud visualisation module renders the label data from a specific topic in `mainMap`, `subMaps`, `mainModel`, and `subModel` files, produced by the Topic Mapping Pipeline bubble map and model export modules.

A Wordcloud is instantiated using `tMap`'s `WordCloud` function. Like most page modules, it takes three parameters: a DOM `container`, and initial `width` and `height`. These parameters are typically returned by the [Page Manager](#page-manager).
```javascript
let PM = tMap.PageManager(...);
let wordcloud = tMap.WordCloud(PM.panel3.c, PM.panel3.w, PM.panel3.h);
```

This module is built with [the visualisation API](#visualisation-api) and therefore has the same base methods.

> Note that all of the functions below return the visualisation module itself, unless specified otherwise.
> This allows you to chain this functions.

#### `WordCloud.setMaxNumberLabels(number)`

Sets the maximum number of labels rendered on the wordcloud. The default value is `50`.
```javascript
wordcloud.setMaxNumberLabels(30); // -> the wordcloud will render a maximum of 30 labels
```

#### `WordCloud.setTextSizeRange([min, max])`

Sets the range, in pixel, at which the labels will be rendered. The default range is set to `[10,25]`.
```javascript
wordcloud.setTextSizeRange([20, 30]); // -> the labels' size will be set between 20 and 30 pixel (small range) 
wordcloud.setTextSizeRange([10, 35]); // -> the labels' size will be set between 20 and 30 pixel (large range)
```

Note that this range is only relative (within labels), the wordcloud is scaled after each render to fit inside its SVG.

#### `WordCloud.setWordClick(callback)`

Sets the callback for click events on the wordcloud's labels.
```javascript
wordcloud.setWordClick((e,d)=>{console.log(d.text)}); // -> on word click print the labels' text
```

> Note that the callback has to follow D3 v6.0's callback signature:
> `callback(event, datum)`
> Check [D3 v6.0 migration guide](https://observablehq.com/@d3/d3v6-migration-guide#events) for more details

#### `WordCloud.setWordMouseover(callbackMouseover, callbackMouseout)`

Sets the callbacks for mouse-over/out events on the wordcloud's labels.
```javascript
wordcloud.setWordMouseover((e,d)=>{console.log(d.text+' over')}, (e,d)=>{console.log(d.text+' out')}); // -> on word click print the labels' text + over/out
```

> Note that the callbacks have to follow D3 v6.0's callback signature:
> `callback(event, datum)`
> Check [D3 v6.0 migration guide](https://observablehq.com/@d3/d3v6-migration-guide#events) for more details

#### `WordCloud.render(labelsData)`

Renders the wordcloud using the provided `labelsData`. Label data can be accessed from topic's data: `topic.labels`.
```javascript
function bubbleClickCallback(e,d){
    wordcloud.render(d.labels);
}
bubblemap.setBubbleClick(bubbleClickCallback); // -> upon clicking on a bubble in bubblemap, will render the associated topic's labels in the wordcloud
```

#### `WordCloud.highlightTexts(words)`

Provided a list of words, will highlight the associated labels using the CSS class `highlighted`.
```javascript
wordcloud.highlightTexts(['label1','label2']); // -> the words 'label1' and 'label2' will be marked as 'highlighted' in the wordcloud
```

#### `WordCloud.highlightTextsOpacity(words)`

Provided a list of words, will lower the opacity of every other words in the wordcloud, using the CSS class `lowerOpacity`.
```javascript
wordcloud.highlightTextsOpacity(['label1','label2']); // -> every words which are not 'label1' or 'label2' will be marked as 'lowerOpacity' in the wordcloud
```


### Trend Chart

The trend chart visualisation module renders date distribution data from the [Data Manager's trend features](#trend-features), itself working with data from the Topic Mapping Pipeline distribute topics module, when applied on dates.

A Trend Chart is instantiated using `tMap`'s `TrendChart` function. Like most page modules, it takes three parameters: a DOM `container`, and initial `width` and `height`. These parameters are typically returned by the [Page Manager](#page-manager).
```javascript
let PM = tMap.PageManager(...);
let trendchart = tMap.TrendChart(PM.panel4.c, PM.panel4.w, PM.panel4.h);
```

This module is built with [the visualisation API](#visualisation-api) and therefore has the same base methods.

> Note that all of the functions below return the visualisation module itself, unless specified otherwise.
> This allows you to chain this functions.

#### `TrendChart.setMarginLeft(value)`

Sets the left margin for the trend chart. This function is mostly useful to adjust the space for the axis labels.
```javascript
trendchart.setMarginLeft(30); // -> the left margin will now be 30 pixels
```

#### `TrendChart.setMarginBottom(value)`

Sets the bottom margin for the trend chart. This function is mostly useful to adjust the space for the axis labels.
```javascript
trendchart.setMarginBottom(20); // -> the left margin will now be 20 pixels
```

#### `TrendChart.setValueTicks([number [, tickFormat]])`

Allows you to the set the number and format of tick marks on the chart's continuous value axis. By default, there are 10 ticks with no specific format.
```javascript
trendchart.setValueTicks(6, '.1f'); // -> put 6 tick marks formated to be fixed 1 decimal with
```
Refer to [D3's number format module](https://github.com/d3/d3-format) for more details on formats.

#### `TrendChart.setDateTicks(inFormat [, outFormat])`

Allows you to set the format of tick marks on the chart's category axis, i.e. the dates. `inFormat` should be the date format in the data. `outFormat` allows you to set a different format for the tick marks, by default it will be the same as the format in the data.
```javascript
trendchart.setDateTicks('%Y-%m'); // -> expecting the date in the data to be like '2013-07', and will have the ticks as such
trendchart.setDateTicks('%Y-%m', '%b. %Y'); // -> expecting the date in the data to be like '2013-07', and will have the ticks like 'Jul. 2013'
```
Refer to [D3's time format module](https://github.com/d3/d3-time-format) for more details on time formats.

#### `TrendChart.setMaxValue(value)`

Sets the chart's maximum value on the value axis. Since the continuous scale is adjusted at every render, this allows you to keep the same scale (`0, maxValue`). The default maximum value is `-1`, which is interpreted as no maximum, i.e. use the next render maximum. 
```javascript
trendchart.setMaxValue(1); // -> the maximum value will always be 1, i.e. 100% if formated with '.0%'
```

#### `TrendChart.setTransition([duration [, delay]])`

Sets the duration and delay (per bar) values for transition animation on the trend chart. These values default to `100`ms for `duration` and `50`ms for delay. You can disable transitions by setting the duration value to `0`.
```javascript
trendchart.setTransition(200, 100); // -> sets the transitions to 200ms duration and 100ms delay (per bar)
```

#### `TrendChart.setTooltip(textFunction)`

Sets the function used to build the trend bars' tooltip text. If defined, this text function will be called with the bar's datum as parameter. You can set this text function to `null` in order to disable the text tooltip.
```javascript
trend.setTooltip(d=>`<b>${d.date}</b>: ${d.value}`); // trend bars' tooltip will print '<b>2018</b>: 0.32' for example.
```

#### `TrendChart.setTooltipChart(charFunction)`

Sets the function used to build the trend bars' tooltip chart. If defined, this chart function will be called with the tooltip's DOM container and the bar's datum as parameter. You can set this chart function to `null` in order to disable the chart tooltip.
```javascript
let DM = tMap.DataManager();
trendchart.setTooltipChart((t,d)=>{
    tMap.HorizontalBarChart(t, 200, 100)
        .render(DM.getMainTopicsDistrib(d.date));
}); // tredn bars' tooltip include an horizontal bar chart showing the bar's date/key field distribution.
```

#### `TrendChart.setBarClick(callback)`

Sets the callback for click events on the trend bars.
```javascript
trendchart.setBarClick((e,d)=>{console.log(d.key)}); // -> on bar click print the bar's key
```

> Note that the callback has to follow D3 v6.0's callback signature:
> `callback(event, datum)`
> Check [D3 v6.0 migration guide](https://observablehq.com/@d3/d3v6-migration-guide#events) for more details 

#### `TrendChart.render(trendDataSeries)`

Renders the trend chart using the provided trend data series (in the format: `[[{date,value}]]`). This type of data is typically obtained from the [Data Maneger's tren features](#trend-features). You can pass one or multiple series.
```javascript
let DM = tMap.DataManager();
let sumByYear = DM.timeFormatConverter('%d/%m/%y', '%Y'); // -> reduce the trend data by year
let trendRange = ['%d/%m/%y', '01/01/11', '01/01/20']; // -> get data between 2011 (inc.) and 2020 (exc.)

trendchart.render([DM.getMainTopicTrend('3', sumByYear, trendsRange)]);
// -> renders the trend data for the main topic '3'

trendchart.render([DM.getMainTopicTrend('3', sumByYear, trendsRange),
                   DM.getSubTopicTrend('11', sumByYear, trendsRange)]);
// -> renders the trend data for the main topic '3' and sub topic '11'
```

#### `TrendChart.selectBar([date])`

Sets the trend bar with key `date` as selected, using the CSS class `selected`. The parameter `date` is optional, not providing it, or setting it as `null`, will unselect any previously selected bar.
```javascript
trendchart.selectBar('2013'); // -> bar with date '2013' is marked as selected
trendchart.selectBar(); // -> every bar are unselected
```


### Bar Chart

The bar chart visualisation modules render distribution data from the [Data Manager's distributions features](#distribution-features), itself working with data from the Topic Mapping Pipeline distribute topics module.

There are two versions of bar charts: horizontal and vertical.

A Bar Chart is instantiated using `tMap`'s `HorizontalBarChart` or `VerticalBarChart` functions. Like most page modules, they take three parameters: a DOM `container`, and initial `width` and `height`. These parameters are typically returned by the [Page Manager](#page-manager).
```javascript
let PM = tMap.PageManager(...);
let barchat1 = tMap.HorizontalBarChart(PM.panel4.c, PM.panel4.w, PM.panel4.h);
let barchat2 = tMap.VerticalBarChart(PM.panel5.c, PM.panel5.w, PM.panel5.h);
```

These modules are built with [the visualisation API](#visualisation-api) and therefore have the same base methods.

> Note that all of the functions below return the visualisation module itself, unless specified otherwise.
> This allows you to chain this functions.

#### `BarChart.setMarginLeft(value)`

Sets the left margin for the bar chart. This function is mostly useful to adjust the space for the axis labels.
```javascript
barchart.setMarginLeft(30); // -> the left margin will now be 30 pixels
```

#### `BarChart.setMarginBottom(value)`

Sets the bottom margin for the bar chart. This function is mostly useful to adjust the space for the axis labels.
```javascript
barchart.setMarginBottom(20); // -> the left margin will now be 20 pixels
```

#### `BarChart.setTicks([number [, format]])`

Allows you to the set the number and format of tick marks on the charts' continuous axis. By default, there are 10 ticks with no specific format.
```javascript
barchart.setTicks(5, '.0%'); // -> put 5 tick marks formated to be percentages with no decimal points
```
Refer to [D3's number format module](https://github.com/d3/d3-format) for more details on formats.

#### `BarChart.setMaxValue(value)`

Sets the chart's maximum value on the continuous axis. Since the continuous scale is adjusted at every render, this allows you to keep the same scale (`0, maxValue`). The default maximum value is `-1`, which is interpreted as no maximum, i.e. use the next render maximum. 
```javascript
barchart.setMaxValue(1); // -> the maximum value will always be 1, i.e. 100% if formated with '.0%'
```

#### `BarChart.setTransition([duration [, delay]])`

Sets the duration and delay (per bar) values for transition animation on the bar chart. These values default to `100`ms for `duration` and `50`ms for delay. You can disable transitions by setting the duration value to `0`.
```javascript
barchart.setTransition(200, 100); // -> sets the transitions to 200ms duration and 100ms delay (per bar)
```

#### `BarChart.setTooltip(textFunction)`

Sets the function used to build the bars' tooltip text. If defined, this text function will be called with the bar's datum as parameter. You can set this text function to `null` in order to disable the text tooltip.
```javascript
barchart.setTooltip(d=>`<b>${d.key}</b>: ${d.value}`); // bars' tooltip will print '<b>A</b>: 0.32' for example.
```

#### `BarChart.setTooltipChart(charFunction)`

Sets the function used to build the bars' tooltip chart. If defined, this chart function will be called with the tooltip's DOM container and the bar's datum as parameter. You can set this chart function to `null` in order to disable the chart tooltip.
```javascript
let DM = tMap.DataManager();
barchart.setTooltipChart((t,d)=>{
    tMap.HorizontalBarChart(t, 200, 100)
        .render(DM.getMainTopicsDistrib(d.key));
}); // bars' tooltip include an horizontal bar chart showing the bar's key field distribution.
```

#### `BarChart.setBarClick(callback)`

Sets the callback for click events on the bars.
```javascript
barchart.setBarClick((e,d)=>{console.log(d.key)}); // -> on bar click print the bar's key
```

> Note that the callback has to follow D3 v6.0's callback signature:
> `callback(event, datum)`
> Check [D3 v6.0 migration guide](https://observablehq.com/@d3/d3v6-migration-guide#events) for more details 

#### `BarChart.render(distributionData)`

Renders the bar chart using the provided distribution data (in the format: `[{key,value}]`). This type of data is typically obtained from the [Data Maneger's distribution features](#distribution-features).
```javascript
let DM = tMap.DataManager();
barchart.render(DM.getMainTopicDistribEntry('4')); // -> renders the distribution for the main topic '4'
```

#### `BarChart.selectBar([key])`

Sets the bar with key `key` as selected, using the CSS class `selected`. The parameter `key` is optional, not providing it, or setting it as `null` will unselect any previously selected bar.
```javascript
barchart.selectBar('A'); // -> bar with key 'A' is marked as selected
barchart.selectBar(); // -> every bar are unselected
```


### Line Chart

The line chart visualisation module renders a set of data point with two scalar attributes (x and y). This chart is typically used to show the model loglikelihood data, which is currently embedded in the [floating menu module](#floating-menu).

A Line Chart is instantiated using `tMap`'s `LineChart` function. Like most page modules, it takes three parameters: a DOM `container`, and initial `width` and `height`. These parameters are typically returned by the [Page Manager](#page-manager).
```javascript
let PM = tMap.PageManager(...);
let lineChart = tMap.LineChart(PM.panel5.c, PM.panel5.w, PM.panel5.h);
```

This module is built with [the visualisation API](#visualisation-api) and therefore has the same base methods.

#### `LineChart.setMarginLeft(value)`

Sets the left margin for the line chart. This function is mostly useful to adjust the space for the axis labels.
```javascript
linechart.setMarginLeft(30); // -> the left margin will now be 30 pixels
```

#### `LineChart.setMarginBottom(value)`

Sets the bottom margin for the line chart. This function is mostly useful to adjust the space for the axis labels.
```javascript
linechart.setMarginBottom(20); // -> the bottom margin will now be 20 pixels
```

#### `LineChart.setXAxisName(name)`

Sets the horizontal axis name (x). This name is used when showing the tooltips for dots on the line chart. The default name is set to `'x'`.
```javascript
linechart.setXAxisName('Iteration'); // -> dot tooltip will display 'Iteration: 30' for example
```

#### `LineChart.setYAxisName(name)`

Sets the vertical axis name (y). This name is used when showing the tooltips for dots on the line chart. The default name is set to `'y'`.
```javascript
linechart.setYAxisName('Likelihood'); // -> dot tooltip will display 'Likelihood: 7.09' for example
```

#### `LineChart.setAxesNames(nameX, nameY)`

Combines the previous two functions. `nameX` will be used for the horizontal axis, and `nameY` for the vertical axis.
```javascript
linechart.setAxesNames('Iteration', 'Likelihood'); // -> dot tooltip will display 'Iteration: 30<br>Likelihood: 7.09' for example
```

#### `LineChart.setXTicks([number [, format]])`

Allows you to the set the number and format of tick marks on the chart's vertical axis (x). By default, there are 10 ticks with no specific format.
```javascript
linechart.setXTicks(5, '.0f'); // -> put 5 tick marks formated to be in fixed notation with no decimal points
```
Refer to [D3's number format module](https://github.com/d3/d3-format) for more details on formats.

#### `LineChart.setYTicks([number [, format]])`

Allows you to the set the number and format of tick marks on the chart's horizontal axis (y). By default, there are 10 ticks with no specific format.
```javascript
linechart.setXTicks(10, '.2e'); // -> put 10 tick marks formated to be in exponent notation with two decimal points
```
Refer to [D3's number format module](https://github.com/d3/d3-format) for more details on formats.

#### `LineChart.setTicks([numberX [, numberY [, formatX [, formatY]]]])`

Combines the previous two functions. `numberX` and `numberY` will be the number of ticks on the horizontal and vertical axes respectively. `formatX` and `formatY` will be the tick format on the horizontal and vertical axes respectively.
```javascript
linechart.setTicks(5, 10, '.0f', '.2e');
// -> put 5 tick marks formated to be in fixed notation with no decimal points on the horizontal axis
//    and put 10 tick marks formated to be in exponent notation with two decimal points on the vertical axis
```

#### `LineChart.render(dataset)`

Renders the line chart using the provided dataset, which assumes the following format: `[{x,y}]`.
```javascript
let data = [{x:10,y:3.78},{x:20,y:4.789},{x:30,y:6.098}];
linechart.render(data); // -> renders data
```


## Styles

The modules' and page's styles are already predefined and set to work with the scripts rendering them. It is however possible to overwrite some of these styles individually inside a `main.css` file loaded by your HTML document.

Colors and fonts values are however used throughout the modules to ensure consistency. These values can be globally set using the CSS `:root` property:
```css
:root{
    --primary-color: #d65076;
    --primary-color-dark: #ad4965;
    --primary-color-light: #f7e7eb;
    --action-color: #d65076;
    --color-black: #333333;
    --color-dark-grey: #4C4C4C;
    --color-grey: #787878;
    --color-light-grey: #989898;
    --color-lighter-grey: #E3E5E5;
    --color-white: #FEFFFF;

    --color-success: #4CAF50;
    --color-danger: #F44336;
    --color-warning: #FFC107;
    --color-info: #03A9F4;

    --title-font: 'Raleway', sans-serif;
    --text-font: 'Open Sans', sans-serif;
}
```


---

[![CC BY-NC 4.0][cc-by-nc-shield]][cc-by-nc]

This work is licensed under a [Creative Commons Attribution 4.0 International
License][cc-by-nc].

[![CC BY-NC 4.0][cc-by-nc-image]][cc-by-nc]

[cc-by-nc]: http://creativecommons.org/licenses/by-nc/4.0/
[cc-by-nc-image]: https://i.creativecommons.org/l/by-nc/4.0/88x31.png
[cc-by-nc-shield]: https://img.shields.io/badge/License-CC%20BY--NC%204.0-lightgrey.svg
