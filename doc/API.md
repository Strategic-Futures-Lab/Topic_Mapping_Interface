# Topic Mapping Interface - API doc

The Topic Mapping Interface script and stylesheet bundles are located in [`app/dist`](../app/dist).

The stylesheet contains the styles of all page modules as well as default styles for the page overall.
Check [this section](#styles) for more details.

The script sets up `tMap`, the top level library object for interacting with the Topic Map interface and its modules.

- [Page Layout Management](#page-manager)
- [Data Management](#data-manager)

## Page Manager

The page manager sets a grid on the HTML page that will automatically position and size containers for the modules.

It is instantiated as follow:
```javascript
let PM = tMap.PageManager(container, layout, controls, header, footer, minWidth, minHeight);
```
- `container` is a string selector for the DOM element that will contain all modules, e.g. `'div#app'`. It defaults to `'body'`.
- `layout` is a string specifying the desired page layout. It defaults to `'A'` (one panel taking the whole space).
- `controls` is a string specifying the desired page controls and there position. It defaults to `''` (no controls).
- `header` and `footer` are the string selectors for the DOM element acting as page header and footer. Their height will be deducted when computing the page size. They both default to `''` (no element).
- `minWidth` and `minHeight` are integers used to set the page minimum size. They both default to `600`. 

For more detail about the layout and controls parameters, check [this page](./PageLayouts.md).

The Page Manager instance created, `PM`, is an object listing the selectors and sizes of each panels generated. For example, if you choose to generate layout with 3 panels and 2 controls, `PM` will contain 5 attributes: `panel1`, `panel2`, `panel3`, `control1`, and `control2`. Each of these attributes will have 3 attributes of their own: `c` the string selector for the container created, `w` the width available for it, and `h` the height.
```javascript
PM.panel1.c // --> the selector for panel1 container, typically 'div#panel1'
PM.panel1.w // --> the width available for panel1, e.g. 500
PM.panel1.h // --> the height available for panel1, e.g. 300
```

### Page Responsivity

The Page Manager instance also has a `watch` function available:
```javascript
PM.watch({
    panel: module
})
```

This provides a map between the panels' names and the interface modules. During window resizing, Page Manager will recompute the panels' sizes and automatically updates the modules.

## Data Manager

The data manager facilitates the loading and interaction with the data files generated by the Topic Mapping Pipeline.

It is instantiated as follow:
```javascript
let DM = tMap.DataManager();
```

You can then access the data management features from `DM`.

- [Processing Data](#processing-data)
- [Map features](#map-features)
- [Document List features](#document-list-features)
- [Distribution features](#distribution-features)
- [Trend features](#trend-features)
- [Search features](#search-features)

### Processing Data

#### `DataManager.loadDataFromUrls(urls)`

Loads data from the urls provided. The urls must be given in a object:
```javascript
DM.loadDataFromUrls({name1: url1, name2: url2});
``` 
Returns a promise object with a list of the loaded data as parameter, e.g.:
```javascript
[{name:name1,data:data1},{name:name2,data:data2}]
``` 

JSON and CSV files will be automatically parsed. Other formats will simply be read as a regular string.

#### `DataManager.processData(dataArray)`

Gets a setof data in the format `[{name,data}]` (i.e. generated by `.loadDataFromUrls`) and attaches the data to the data manager. For example:
```javascript
DM.processData([{name:name1,data:data1},{name:name2,data:data2}]);
``` 
Will be attached to `DM` like so:
```javascript
DM.data.name1 // -> data1
DM.data.name2 // -> data2
```

#### `DataManager.loadAndProcessDataFromUrls(urls)`

Combines `.loadDataFromUrls` and `.processData` together. Takes a set of urls as input, attaches the data to the data manager instance, and returns a promise object (with no parameters):
```javascript
DM.loadAndProcessDataFromUrls({name1: url1, name2: url2}).then(()=>{
    console.log(DM.data.name1); // -> data1
    console.log(DM.data.name2); // -> data2
});
```

#### Important Notes

While any url and data name can be passed to `.loadAndProcessDataFromUrls`, other features of the data manager expect specific names and data structures:
- `mainMap` (and `subMaps`): the main map (and set of sub maps) JSON file(s) generated by the Topic Mapping Pipeline's mapping modules;
- `mainModel` (and `subModel`): the main model (and sub model) JSON file(s) generated by the Topic Mapping Pipeline's export model module;
- `distribution`: any distribution JSON file generated by the Topic Mapping Pipeline's topic distribution module (only one non-date `distribution` is supported);
- `trend`: a date distribution JSON file generated by the Topic Mapping Pipeline's topic distribution module;
- `labelsIndex`: the labels index JSON file generated by the Topic Mapping Pipeline's label indexing module.

These features provide shortcut to accessing and processing the data files to fit with the page's modules.

### Map features

These features let you access and interact with the data from `mainMap` and `subMaps`.

#### `DataManager.setSubMap(topicId)`

Given a the id of a topic from the main map, gets the sub map data attached to it and saves it to the `subMap` data attribute of the manager (for later access). Will throw and error if `subMaps` was not loaded or if no sub map can be found with this main topic id.
```javascript
DM.setSubMap('2');
console.log(DM.data.subMap); // -> sub map data assigned to main topic with id '2'
```

#### `DataManager.getSubMap([topicId])`

Same as `.setSubMap` but also returns the sub map data. `topicId` is optional here. If unspecified, the function will return the sub map data previously saved. If no sub map was previously set and no topic id is provided, the function will throw an error. The function can also throw errors from `.setSubMap` by proxy.
```javascript
let map = DM.getSubMap('2');
console.log(map); // -> sub map data assigned to main topic with id '2'

DM.setSubMap('5');
let map = DM.getSubMap();
console.log(map); // -> sub map data assigned to main topic with id '5'
```

#### `DataManager.getTopicMainMap(topicId)`

Returns the data (labels, position, etc.) for the topic with id `topicId` from the main map. Will throw an error if `mainMap` was not loaded or if no topic can be found with the specified id.
```javascript
let t = DM.getTopicMainMap('3');
console.log(t); // -> topic data for topic with id '3' in main map
```

#### `DataManager.getTopicSubMap(topicId)`

Returns the data (labels, position, etc.) for the topic with id `topicId` from the sub map previously saved with `setSubMap`. Will throw an error if no sub map was previously set or if no topic can be found with the specified id.
```javascript
let t = DM.getTopicSubMap('1');
console.log(t); // -> topic data for topic with id '1' in sub map
```

### Document List features

These features let you access and interact with the document lists inside the `mainModel` and `subModel`.

#### `DataManager.setTableRowsMainTopic(topicId)`

Given a topic id from the main model, will set the data attribute `tableRows` to the topic's top documents. If no topic is found `tableRows` is set to an empty list. If `mainModel` was not loaded, the function will throw an error.
```javascript
DM.setTableRowsMainTopic('4');
console.log(DM.data.tableRows); // -> the list of top documents for topic '4' in the main model
``` 

#### `DataManager.setTableRowsMainTopic(topicId)`

Same as above but with topics from the sub model.
```javascript
DM.setTableRowsSubTopic('6');
console.log(DM.data.tableRows); // -> the list of top documents for topic '6' in the sub model
``` 

#### `DataManager.getTableRows([number [, filter]])`

Returns the list of documents saved in `tableRows` with the methods above. `number` is optional and lets you crop the list to the top x document entries, its default value is `10`. `filter` is optional too and lets you provide a function to filter the documents (before croping the list), its default value is `()=>true` (no filter). The function will throw an error if `tableRows` has not been set.
```javascript
DM.setTableRowsMainTopic('4');
let d = DM.getTableRows(30, d=>d.published);
console.log(d); // -> list of the top 30 documents, that were "published", from topic '4' in the main model 
```

#### `DataManager.getDocument(docId)`

Given a document id, returns the associated document data saved in `tableRows`. The function will throw an error if `tableRows` has not been set or is empty, or if no document with such id can be found. 
```javascript
DM.setTableRowsMainTopic('4');
let d = DM.getDocument('43');
console.log(d); // -> data for the document '43', which is in the top documents for topic '4' in the main model.
```

### Distribution features

These features let you access and interact with the `distribution` data. This type of data is generated by the Topic Mapping Pipeline's topic distribution module. Note that date distributions have [separate features](#trend-features).

#### `DataManager.getDistributionLabels([textTransform])`

Returns the list of the distribution's fields labels. `textTransform` is an optional function that lets you transform the labels' text for display, it defaults to `d=>d` (identity function). The returned list will be in the format: `[{value, text}, ...]` where `value` is the original label value and `text` is the transformed value. This function will throw an error if `distribution` has not been set.
```javascript
let l = DM.getDistributionLabels(t=>`Category ${t}`);
console.log(l); // -> list of fields, e.g. [{value:'A', text:'Category A'},{value:'B', text:'Category B'},{value:'C', text:'Category C'}]
```

#### `DataManager.getMainTopicsDistrib(fieldName)`

Returns the topic distribution of main topics, given a field name. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the field name provided is not part of the distribution.
```javascript
let d = DM.getMainTopicsDistrib('A');
console.log(d); // -> main topic distribution for field A, e.g. [{topicId: '0', value: 32.0}, {topicId: '1', value: 10.0}, ...]
```

#### `DataManager.getSubTopicsDistrib(fieldName)`

Same as above for sub topics.

#### `DataManager.getMainTopicsDistribNormPerTopic(fieldName)`

Returns the topic distribution of main topics, given a field name. The values returned are normalised using the total distribution value for each topic: `v_final = v_topic_field / total_topic`. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the field name provided is not part of the distribution.
```javascript
let d = DM.getMainTopicsDistribNormPerTopic('A');
console.log(d); // -> main topic distribution for field A normalised per topic (across the other fields), e.g. [{topicId: '0', value: 0.3}, {topicId: '1', value: 0.6}, ...]
```

#### `DataManager.getSubTopicsDistribNormPerTopic(fieldName)`

Same as above for sub topics.

#### `DataManager.getMainTopicsDistribNormPerField(fieldName)`

Returns the topic distribution of main topics, given a field name. The values returned are normalised using the total distribution value for each field: `v_final = v_topic_field / total_field`. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the field name provided is not part of the distribution.
```javascript
let d = DM.getMainTopicsDistribNormPerField('A');
console.log(d); // -> main topic distribution for field A normalised across the topics, e.g. [{topicId: '0', value: 0.063}, {topicId: '1', value: 0.13}, ...]
```

#### `DataManager.getSubTopicsDistribNormPerField(fieldName)`

Same as above for sub topics.

#### `DataManager.getMainTopicDistribEntry(topicId)`

Returns the distribution entry for the topic with the specified id. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the topic id provided is not found.
```javascript
let d = DM.getMainTopicDistribEntry('1');
console.log(d); // -> distribution entry for main topic '1', e.g. [{key: 'A', value: 10.0}, {key: 'B', value: 5.0}, ...]
```

#### `DataManager.getSubTopicDistribEntry(topicId)`

Same as above for sub topics.
  
#### `DataManager.getMainTopicDistribEntryNorm(topicId)`

Returns the distribution entry for the topic with the specified id. Each value returned will be normalised by the total weight for this topic. This function will throw an error if `distribution` has not been set, if the distribution does not have main topics, or if the topic id provided is not found.
```javascript
let d = DM.getMainTopicDistribEntryNorm('1');
console.log(d); // -> distribution entry for main topic '1' normalised, e.g. [{key: 'A', value: 0.6}, {key: 'B', value: 0.3}, ...]
```

#### `DataManager.getSubTopicDistribEntry(topicId)`

Same as above for sub topics.

### Trend features

These features let you access and interact with the `trend` data. This type of data is generated by the Topic Mapping Pipeline's topic distribution module, when applied on date fields.

#### `DataManager.timeFormatConverter(inParse, outFormat)`

Returns a function that converts date formats.
```javascript
let convert = DM.timeFormatConverter('%d/%m/%y', '%Y-%m');
console.log(convert('04/05/12')) // -> '2012-05'
```
Refer to [D3's documentation](https://github.com/d3/d3-time-format#locale_format) for more details about the format specification.

This function is particularly useful when trying to aggregate values by months or years. As such, it also has a duplicate name: `DataManager.getTrendSumByFunction(inParse, outFormat)`.

#### `DataManager.getMainTopicTrend(topicId [,sumBy [,timeRange]])`

Given the id of a main topic, returns the trend for this topic, in the format: `[{date, value}]`. `sumBy` is a optional function that lets you aggregate the distribution value by date, e.g. by month or by year, this function is essentially a date converter that `.timeFormatConverter` or `.getTrendSumByFunction` produce. `timeRange` is a optional range that lets you filter the distribution dates, this range is defined as a list of three strings: `[format, minDate, maxDate]`, `minDate` will be included and `maxDate` excluded.

This function will throw errors if: the trend data was not loaded; the trend data does not have main topics; the topic was not found; or the timeRange, if given, was not correct.

```javascript
let convert = DM.timeFormatConverter('%d/%m/%y', '%Y-%m');
let range = ['%d/%m/%y', '01/01/2012', '01/07/2012'];
let d = DM.getMainTopicTrend('1', convert, range);
console.log(d); // -> trend for the main topic '1', grouped by month, between January and June (both included)
```

#### `DataManager.getMainTopicTrend(topicId [,sumBy [,timeRange]])`

Same as above for sub topics.

#### `DataManager.getMaxTrend([sumBy])`

Returns the maximum value in the `trend` data, across all topics. The optional `sumBy` function lets you aggregate the maximum value by a specific time period (year, month, etc.).
```javascript
let convert = DM.timeFormatConverter('%d/%m/%y', '%Y-%m');
let maxValue = DM.getMaxTrend(convert);
console.log(maxValue); // -> maximum value of the trend, across all topics, by month
```

### Search features

These features let you access and interact with the `labelsIndex` data, enabling search functionalities.

#### `DataManager.setSearchTerm(string)`

Saves a string as the search term for later functions.
```javascript
DM.setSearchTerm('label1 label2; label3');
console.log(DM.data.searchTerm); // -> 'label1 label2; label3'
```

The search term can be composed of multiple labels, organised with logic operators:
- `and`, `+`, ` ` (space): connect labels with an `AND`;
- `or`, `*`, `;`: connect labels (or multiple labels connected by `AND`) with an `OR`;

If the search term comprises only one word, with space at the end of it, the future search functions will consider every labels containting this word as substring.

#### `DataManager.processWordInSearch(word [,searchValue [,append]])`

Allows you to safely process a word in a search string. If the word is not in the search, the function will append it to the end of the search string (with the `append` character which defaults to `;`). If the word is already in the search, the function will remove it. `searchValue` is optional (defaults to `null`), if not specified or set to `null`, the function will use the search term set by `.setSearchTerm` and update it. The function returns the new search string.
```javascript
let s = DM.processWordInSearch('word', 'search string', '-');
console.log(s); // -> 'search string- word'

let s = DM.processWordInSearch('search', 'search string');
console.log(s); // -> 'string'

DM.setSearchTerm('label1 label2; label3');
DM.processWordInSearch('label4');
console.log(DM.data.searchTerm); // -> 'label1 label2; label3; label4'
```

#### `DataManager.getDocIdsFromSearch()`

Returns the ids of documents matching the search term set with `.setSearchTerm` in the `labelsIndex` data. The function will throw an error if `labelsIndex` has not been set.
```javascript
DM.setSearchTerm('label1 label2; label3');
let docIds = DM.getDocIdsFromSearch();
console.log(docIds); // -> the list of document ids containing 'label1' and 'label2', or 'label3'

DM.setSearchTerm('lab');
let docIds = DM.getDocIdsFromSearch();
console.log(docIds); // -> the list of document ids containing 'label1', 'label2', 'label3', or 'laboratory' ...
```

#### `DataManager.getTopicIdsFromSearch()`

Returns two sets of ids for the main and sub topics matching the search term set with `.setSearchTerm` in the `labelsIndex` data. The function will throw an error if `labelsIndex` has not been set.
```javascript
DM.setSearchTerm('label1 label2; label3');
let {mainTopicIds, subTopicIds} = DM.getTopicIdsFromSearch();
console.log(mainTopicIds); // -> the list of main topic ids containing 'label1' and 'label2', or 'label3'
console.log(subTopicIds); // -> the list of sub topic ids containing 'label1' and 'label2', or 'label3'

DM.setSearchTerm('lab');
let {mainTopicIds, subTopicIds} = DM.getTopicIdsFromSearch();
console.log(mainTopicIds); // -> the list of main topic ids containing 'label1', 'label2', 'label3', or 'laboratory' ...
console.log(subTopicIds); // -> the list of sub topic ids containing 'label1', 'label2', 'label3', or 'laboratory' ...
```

#### `DataManager.getLabelsFromSearch()`

Returns the exact set of labels matching the search term set with `.setSearchTerm` in the `labelsIndex` data. The function will throw an error if `labelsIndex` has not been set.
```javascript
DM.setSearchTerm('label1 label2; label3');
let labels = DM.getLabelsFromSearch();
console.log(labels); // -> [label1, label2, label3]

DM.setSearchTerm('lab');
let labels = DM.getLabelsFromSearch();
console.log(labels); // -> ['label1', 'label2', 'label3', 'laboratory', ...]
```

#### `DataManager.getFromSearch()`

A wrapper function for `.getLabelsFromSearch`, `.getTopicIdsFromSearch`, and `.getDocIdsFromSearch`, returning a object comprising the results of these other function. The function will throw an error if `labelsIndex` has not been set.

```javascript
DM.setSearchTerm('label1 label2; label3');
let {labels, docs, topics} = DM.getFromSearch();
console.log(topics.mainTopicIds); // -> the list of main topic ids containing 'label1' and 'label2', or 'label3'
console.log(topics.subTopicIds); // -> the list of sub topic ids containing 'label1' and 'label2', or 'label3'
console.log(docIds); // -> the list of document ids containing 'label1' and 'label2', or 'label3'
console.log(labels); // -> [label1, label2, label3]
```

## Styles


---

[![CC BY-NC 4.0][cc-by-nc-shield]][cc-by-nc]

This work is licensed under a [Creative Commons Attribution 4.0 International
License][cc-by-nc].

[![CC BY-NC 4.0][cc-by-nc-image]][cc-by-nc]

[cc-by-nc]: http://creativecommons.org/licenses/by-nc/4.0/
[cc-by-nc-image]: https://i.creativecommons.org/l/by-nc/4.0/88x31.png
[cc-by-nc-shield]: https://img.shields.io/badge/License-CC%20BY--NC%204.0-lightgrey.svg
